name: Build inventory feed

on:
  schedule:
    - cron: "0 2 * * *"   # täglich 02:00 UTC
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas paramiko chardet

      - name: Fetch from SFTP & build CSV
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_PATH: ${{ secrets.SFTP_PATH }}
          THRESHOLD: ${{ secrets.THRESHOLD }}
        run: |
          python << 'PY'
          import os, io, chardet, pandas as pd
          import paramiko

          host=os.environ["SFTP_HOST"]; user=os.environ["SFTP_USER"]; pw=os.environ["SFTP_PASS"]
          path=os.environ["SFTP_PATH"];  thr=int(os.environ.get("THRESHOLD","6"))

          # SFTP laden
          t=paramiko.Transport((host,22)); t.connect(username=user,password=pw)
          s=paramiko.SFTPClient.from_transport(t)
          buf=io.BytesIO(); s.getfo(path, buf); s.close(); t.close()
          data=buf.getvalue()

          enc=chardet.detect(data)["encoding"] or "utf-8"
          text=data.decode(enc, errors="replace")

          # Semikolons → Komma
          text=text.replace(";", ",")

          # CSV einlesen
          df=pd.read_csv(io.StringIO(text))

          # Erwartete Spalten:
          #   "Variant SKU" und "Variant Inventory Qty" (oder "Quantity")
          if "Variant Inventory Qty" in df.columns:
              qty_col="Variant Inventory Qty"
          elif "Quantity" in df.columns:
              qty_col="Quantity"
          else:
              raise SystemExit("Keine Mengen-Spalte gefunden (erwartet: Quantity oder Variant Inventory Qty)")

          if "Variant SKU" not in df.columns:
              raise SystemExit("Spalte 'Variant SKU' fehlt (SKU muss vorhanden sein)")

          # Sicherheitsbestand abziehen
          df["Variant Inventory Qty"] = (df[qty_col].fillna(0).astype(float) - thr).clip(lower=0).astype(int)

          # Minimal-CSV für Matrixify
          out=df[["Variant SKU","Variant Inventory Qty"]].copy()
          out.to_csv("stocklist_utf8.csv", index=False)

          print(out.head())
          PY

      - name: Commit feed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add stocklist_utf8.csv
          git commit -m "build: inventory feed" || echo "no changes"
          git push
