name: Build inventory feed

on:
  schedule:
    - cron: "0 2 * * *"   # täglich 02:00 UTC
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas paramiko chardet

      - name: Fetch from SFTP & build CSV
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_PATH: ${{ secrets.SFTP_PATH }}
          THRESHOLD: ${{ secrets.THRESHOLD }}
        run: |
          python << 'PY'
          import os, io, chardet, pandas as pd, csv, re
          import paramiko
          
          host=os.environ["SFTP_HOST"]; user=os.environ["SFTP_USER"]; pw=os.environ["SFTP_PASS"]
          path=os.environ["SFTP_PATH"];  thr=int(os.environ.get("THRESHOLD","6"))
          
          # SFTP laden
          t=paramiko.Transport((host,22)); t.connect(username=user,password=pw)
          s=paramiko.SFTPClient.from_transport(t)
          buf=io.BytesIO(); s.getfo(path, buf); s.close(); t.close()
          data=buf.getvalue()
          
          # Encoding erkennen & dekodieren
          enc = chardet.detect(data)["encoding"] or "utf-8"
          text = data.decode(enc, errors="replace")
          
          # Als SEMIKOLON-CSV einlesen (keine Ersetzung vorab!)
          df = pd.read_csv(
              io.StringIO(text),
              sep=';',
              engine='python',
              quoting=csv.QUOTE_MINIMAL,
              dtype=str,
              keep_default_na=False,
              on_bad_lines='skip'
          )
          
          # Spaltennamen vereinheitlichen
          rename_map = {
              "ItemNo": "Variant SKU",
              "Quantity": "Variant Inventory Qty",
              "Variant Inventory Quantity": "Variant Inventory Qty",
              "Stock": "Variant Inventory Qty"
          }
          df.rename(columns=rename_map, inplace=True)
          
          # Prüfen, ob erforderliche Spalten vorhanden sind
          if "Variant SKU" not in df.columns:
              raise SystemExit("Fehler: Spalte 'ItemNo' bzw. 'Variant SKU' fehlt.")
          if "Variant Inventory Qty" not in df.columns:
              raise SystemExit("Fehler: Spalte 'Quantity' bzw. 'Variant Inventory Qty' fehlt.")
          
          # Menge bereinigen (Zahlen extrahieren & Sicherheitsbestand abziehen)
          def to_num(x):
              import re
              if not x: return 0
              x = str(x).strip().replace('.', '').replace(',', '.')
              m = re.search(r"-?\d+(\.\d+)?", x)
              return float(m.group()) if m else 0.0
          
          thr = int(os.environ.get("THRESHOLD", "6"))
          df["Variant Inventory Qty"] = df["Variant Inventory Qty"].map(to_num).sub(thr).clip(lower=0).astype(int)
          
          # Nur benötigte Spalten für Matrixify exportieren
          out = df[["Variant SKU", "Variant Inventory Qty"]].copy()
          out.to_csv("stocklist_utf8.csv", index=False)
          print(out.head())
          PY

      - name: Commit feed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
          git add stocklist_utf8.csv
          git commit -m "build: inventory feed" || echo "no changes"
          git push
